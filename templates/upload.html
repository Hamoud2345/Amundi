{% extends "base.html" %}

{% block title %}Upload CSV - AI Company Assistant{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üìÅ Upload Company Data</h2>
        
        <div x-data="uploadApp()" class="space-y-6">
            <!-- Upload Area -->
            <div 
                @drop.prevent="handleDrop($event)"
                @dragover.prevent
                @dragenter.prevent
                class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
                :class="{ 'border-blue-400 bg-blue-50': isDragging }"
                @dragenter="isDragging = true"
                @dragleave="isDragging = false"
            >
                <div class="space-y-4">
                    <div class="text-4xl">üìÑ</div>
                    <div>
                        <p class="text-lg font-medium text-gray-700">Drop your CSV file here</p>
                        <p class="text-sm text-gray-500">or click to browse</p>
                    </div>
                    <input 
                        type="file" 
                        accept=".csv"
                        @change="handleFileSelect($event)"
                        class="hidden"
                        id="file-input"
                    >
                    <button 
                        @click="document.getElementById('file-input').click()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg"
                    >
                        Choose File
                    </button>
                </div>
            </div>

            <!-- File Info -->
            <div x-show="selectedFile" class="bg-gray-50 rounded-lg p-4">
                <h3 class="font-medium text-gray-800 mb-2">Selected File:</h3>
                <p x-text="selectedFile?.name" class="text-sm text-gray-600"></p>
                <p x-text="selectedFile ? `Size: ${(selectedFile.size / 1024).toFixed(1)} KB` : ''" class="text-xs text-gray-500"></p>
            </div>

            <!-- Upload Button -->
            <div x-show="selectedFile" class="flex space-x-4">
                <button 
                    @click="uploadFile()"
                    :disabled="uploading"
                    class="bg-green-500 hover:bg-green-600 disabled:bg-gray-400 text-white px-6 py-2 rounded-lg"
                >
                    <span x-show="!uploading">Upload Companies</span>
                    <span x-show="uploading">Uploading...</span>
                </button>
                <button 
                    @click="clearFile()"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg"
                >
                    Clear
                </button>
            </div>

            <!-- Results -->
            <div x-show="uploadResult" class="rounded-lg p-4" :class="uploadResult?.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                <h3 class="font-medium mb-2" :class="uploadResult?.success ? 'text-green-800' : 'text-red-800'">
                    <span x-show="uploadResult?.success">‚úÖ Upload Successful!</span>
                    <span x-show="!uploadResult?.success">‚ùå Upload Failed</span>
                </h3>
                <p x-text="uploadResult?.message" class="text-sm" :class="uploadResult?.success ? 'text-green-700' : 'text-red-700'"></p>
                <div x-show="uploadResult?.errors" class="mt-2">
                    <p class="text-sm font-medium text-red-700">Errors:</p>
                    <template x-for="error in uploadResult?.errors">
                        <p x-text="error" class="text-xs text-red-600"></p>
                    </template>
                </div>
            </div>

            <!-- CSV Format Help -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 class="font-medium text-blue-800 mb-2">üìã CSV Format Requirements</h3>
                <p class="text-sm text-blue-700 mb-2">Your CSV file should have the following columns:</p>
                <ul class="text-sm text-blue-600 space-y-1">
                    <li><strong>name</strong> - Company name (required)</li>
                    <li><strong>description</strong> - Company description</li>
                    <li><strong>sector</strong> - Industry sector</li>
                    <li><strong>financials</strong> - JSON string with financial data (optional)</li>
                </ul>
                <div class="mt-3">
                    <p class="text-xs text-blue-600 font-medium">Example:</p>
                    <code class="text-xs bg-white p-2 rounded block mt-1">
name,description,sector,financials<br>
"Tech Corp","AI software company","Technology","{""revenue"": 10000000}"<br>
"Green Energy","Solar panels","Energy","{""revenue"": 5000000}"
                    </code>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function uploadApp() {
    return {
        selectedFile: null,
        uploading: false,
        uploadResult: null,
        isDragging: false,

        handleDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
            }
        },

        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.selectedFile = files[0];
            }
        },

        clearFile() {
            this.selectedFile = null;
            this.uploadResult = null;
            document.getElementById('file-input').value = '';
        },

        async uploadFile() {
            if (!this.selectedFile) return;

            this.uploading = true;
            this.uploadResult = null;

            const formData = new FormData();
            formData.append('file', this.selectedFile);

            try {
                const response = await fetch('/upload-csv/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': this.getCookie('csrftoken')
                    },
                    body: formData
                });

                const data = await response.json();
                
                this.uploadResult = {
                    success: response.ok,
                    message: data.message || data.error,
                    errors: data.errors
                };

                if (response.ok) {
                    // Clear file after successful upload
                    setTimeout(() => this.clearFile(), 3000);
                }

            } catch (error) {
                console.error('Upload error:', error);
                this.uploadResult = {
                    success: false,
                    message: 'Network error occurred during upload'
                };
            } finally {
                this.uploading = false;
            }
        },

        getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    }
}
</script>
{% endblock %}
